# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tool

default_platform(:android)

platform :android do
  desc "Build Android debug APK for development"
  lane :dev_build do
    gradle(task: "clean assembleRelease", project_dir: "./android", properties: {
      "android.injected.signing.store.file" => "#{Dir.pwd}/../credentials/android/release.keystore",
      "android.injected.signing.store.password" => ENV['ANDROID_KEYSTORE_PASSWORD'],
      "android.injected.signing.key.alias" => ENV['ANDROID_KEY_ALIAS'],
      "android.injected.signing.key.password" => ENV['ANDROID_KEY_PASSWORD']
    })
  end

  desc "Submit a new internal test build to play store"
  lane :qa_release do
    previous_build_number = google_play_track_version_codes(
      track: "internal",
      json_key: "credentials/android/google-play-service-key.json"
    )[0]

    increment_version_name(
      gradle_file_path: "android/app/build.gradle"
    )
    increment_version_code(
      gradle_file_path: "android/app/build.gradle",
      version_code: previous_build_number + 1
    )

    gradle(task: "clean bundleRelease", project_dir: "./android", properties: {
      "android.injected.signing.store.file" => "#{Dir.pwd}/../credentials/android/release.keystore",
      "android.injected.signing.store.password" => ENV['ANDROID_KEYSTORE_PASSWORD'],
      "android.injected.signing.key.alias" => ENV['ANDROID_KEY_ALIAS'],
      "android.injected.signing.key.password" => ENV['ANDROID_KEY_PASSWORD']
    })

    upload_to_play_store(
      track: 'internal',
      json_key: "credentials/android/google-play-service-key.json",
      aab: "android/app/build/outputs/bundle/release/app-release.aab"
    )

    changelog_from_git_commits
  end

  desc "Submit a new staging build to play store"
  lane :stg_release do
    increment_version_name(
      gradle_file_path: "android/app/build.gradle"
    )
    increment_version_code(
      gradle_file_path: "android/app/build.gradle"
    )

    gradle(task: "clean bundleRelease", project_dir: "./android", properties: {
      "android.injected.signing.store.file" => "#{Dir.pwd}/../credentials/android/release.keystore",
      "android.injected.signing.store.password" => ENV['ANDROID_KEYSTORE_PASSWORD'],
      "android.injected.signing.key.alias" => ENV['ANDROID_KEY_ALIAS'],
      "android.injected.signing.key.password" => ENV['ANDROID_KEY_PASSWORD']
    })

    upload_to_play_store(
      track: 'closed',
      json_key: "credentials/android/google-play-service-key.json",
      aab: "android/app/build/outputs/bundle/release/app-release.aab"
    )

    changelog_from_git_commits
  end

  desc "Submit a new production build to play store"
  lane :production_release do
    increment_version_name(
      gradle_file_path: "android/app/build.gradle"
    )
    increment_version_code(
      gradle_file_path: "android/app/build.gradle"
    )

    gradle(task: "clean bundleRelease", project_dir: "./android", properties: {
      "android.injected.signing.store.file" => "#{Dir.pwd}/../credentials/android/release.keystore",
      "android.injected.signing.store.password" => ENV['ANDROID_KEYSTORE_PASSWORD'],
      "android.injected.signing.key.alias" => ENV['ANDROID_KEY_ALIAS'],
      "android.injected.signing.key.password" => ENV['ANDROID_KEY_PASSWORD']
    })

    upload_to_play_store(
      track: 'production',
      release_status: "draft",
      json_key: "credentials/android/google-play-service-key.json",
      aab: "android/app/build/outputs/bundle/release/app-release.aab"
    )
  end
end

platform :ios do

  desc "Build iOS simulator app for development"
  lane :dev_build do
    build_ios_app(
      workspace: "ios/smbmobile.xcworkspace",
      scheme: "smbmobile",
      sdk: "iphonesimulator",
      configuration: "Debug",
      derived_data_path: "ios/build",
      output_directory: "ios/build",
      output_name: "smbmobile.app"
    )
  end

  desc "Submit a new QA build to TestFlight"
  lane :qa_release do
    UI.important "ğŸš€ ============================================="
    UI.important "ğŸš€ Starting iOS QA Release Lane"
    UI.important "ğŸš€ ============================================="
    
    UI.message "ğŸ“‹ Step 1/8: Setting up App Store Connect API authentication"
    UI.message "   - Key ID: #{ENV['APP_STORE_CONNECT_API_KEY_ID']}"
    UI.message "   - Issuer ID: #{ENV['APP_STORE_CONNECT_ISSUER_ID']}"
    UI.message "   - Key file path: #{Dir.pwd}/../credentials/ios/AuthKey.p8"
    
    # Verify the key file exists
    key_path = "#{Dir.pwd}/../credentials/ios/AuthKey.p8"
    if File.exist?(key_path)
      UI.success "âœ… AuthKey.p8 file found (#{File.size(key_path)} bytes)"
    else
      UI.user_error! "âŒ AuthKey.p8 file not found at: #{key_path}"
    end
    
    # Setup App Store Connect API authentication
    api_key = app_store_connect_api_key(
      key_id: ENV['APP_STORE_CONNECT_API_KEY_ID'],
      issuer_id: ENV['APP_STORE_CONNECT_ISSUER_ID'],
      key_filepath: key_path
    )
    UI.success "âœ… App Store Connect API key configured"

    UI.message ""
    UI.message "ğŸ“‹ Step 2/8: Fetching provisioning profiles and certificates"
    UI.message "   - Type: appstore"
    UI.message "   - App Identifier: com.insighture.smbmobile"
    UI.message "   - Git URL: git@github.com:insighture/smb-mobile-fastlane.git"
    UI.message "   - Keychain: #{ENV['KEYCHAIN_NAME']}"
    
    begin
      # Fetch App Store provisioning profiles and certificates from private Git repo
      match(
        type: "appstore",
        readonly: false,
        app_identifier: "com.insighture.smbmobile",
        git_url: "git@github.com:insighture/smb-mobile-fastlane.git",
        api_key: api_key,
        force_for_new_devices: true,
        keychain_password: ENV['KEYCHAIN_PASSWORD'],
        keychain_name: ENV['KEYCHAIN_NAME'],
        verbose: true
      )
      UI.success "âœ… Provisioning profiles and certificates synced successfully"
    rescue => ex
      UI.error "âŒ Failed to sync provisioning profiles"
      UI.error "Error: #{ex.message}"
      UI.error "Backtrace: #{ex.backtrace.first(5).join("\n")}"
      raise ex
    end
    
    UI.message ""
    UI.message "ğŸ“‹ Step 3/8: Updating code signing settings"
    
    # update_code_signing_settings requires path relative to fastlane execution (project root)
    # Fastlane changes to project root for this action
    project_path = "ios/smbmobile.xcodeproj"
    
    UI.message "   - Project: #{project_path}"
    UI.message "   - Team ID: 96W7U4JYV4"
    UI.message "   - Profile: match AppStore com.insighture.smbmobile"
    UI.message "   - Identity: iPhone Distribution"
    
    begin
      update_code_signing_settings(
        use_automatic_signing: false,
        path: project_path,
        team_id: "96W7U4JYV4",
        profile_name: "match AppStore com.insighture.smbmobile",
        code_sign_identity: "iPhone Distribution",
        targets: ["smbmobile"],
        build_configurations: ["Release"]
      )
      UI.success "âœ… Code signing settings updated"
    rescue => ex
      UI.error "âŒ Failed to update code signing settings"
      UI.error "Error: #{ex.message}"
      raise ex
    end

    UI.message ""
    UI.message "ğŸ“‹ Step 4/8: Incrementing version number"
    
    # Version actions also run from project root context
    project_path = "ios/smbmobile.xcodeproj"
    
    # Get current version first
    current_version = get_version_number(xcodeproj: project_path)
    UI.message "   - Current version: #{current_version}"
    
    # Increment version number
    increment_version_number(
      xcodeproj: project_path,
      bump_type: "patch"
    )
    
    new_version = get_version_number(xcodeproj: project_path)
    UI.success "âœ… Version incremented: #{current_version} â†’ #{new_version}"
    
    UI.message ""
    UI.message "ğŸ“‹ Step 5/8: Incrementing build number"
    
    # Build number actions also run from project root context
    project_path = "ios/smbmobile.xcodeproj"
    
    # Get latest TestFlight build and increment
    begin
      UI.message "   - Fetching latest TestFlight build number..."
      latest_build = latest_testflight_build_number(
        app_identifier: "com.insighture.smbmobile",
        api_key: api_key
      )
      UI.message "   - Latest TestFlight build: #{latest_build}"
      new_build = latest_build + 1
      UI.message "   - Setting new build number: #{new_build}"
      
      increment_build_number(
        xcodeproj: project_path,
        build_number: new_build
      )
      UI.success "âœ… Build number set to: #{new_build}"
    rescue => ex
      UI.warning "âš ï¸  Could not fetch latest TestFlight build: #{ex.message}"
      UI.message "   - Incrementing from current build number..."
      current_build = get_build_number(xcodeproj: project_path)
      UI.message "   - Current build: #{current_build}"
      increment_build_number(xcodeproj: project_path)
      new_build = get_build_number(xcodeproj: project_path)
      UI.success "âœ… Build number incremented to: #{new_build}"
    end

    UI.message ""
    UI.message "ğŸ“‹ Step 6/8: Building iOS app"
    UI.important "âš™ï¸  Build Configuration:"
    UI.message "   - Workspace: ios/smbmobile.xcworkspace"
    UI.message "   - Scheme: smbmobile"
    UI.message "   - Configuration: Release"
    UI.message "   - Export method: app-store"
    UI.message "   - Output: ios/build/smbmobile.ipa"
    UI.message "   - SDK: iphoneos"
    UI.message "   - Destination: generic/platform=iOS"
    UI.message "   - Team ID: 96W7U4JYV4"
    UI.message ""
    
    # Debug: Show current directory and file structure
    UI.message "ğŸ” Debug: Checking file system..."
    UI.message "   - Current directory: #{Dir.pwd}"
    UI.message "   - Project root: #{File.expand_path('..')}"
    
    # Our Ruby code runs from fastlane/ dir, so use ../ios/ for checks
    # But Fastlane actions will use ios/ (they chdir to project root)
    ruby_ios_path = "../ios"
    fastlane_ios_path = "ios"
    
    # Check if ios directory exists (from our current fastlane/ directory)
    if Dir.exist?(ruby_ios_path)
      UI.success "   - âœ… #{ruby_ios_path}/ directory exists"
      UI.message "   - Files in #{ruby_ios_path}/ directory:"
      Dir.entries(ruby_ios_path).select { |f| !f.start_with?('.') }.first(20).each do |f|
        UI.message "     - #{f}#{File.directory?("#{ruby_ios_path}/#{f}") ? '/' : ''}"
      end
    else
      UI.error "   - âŒ #{ruby_ios_path}/ directory does not exist!"
    end
    
    UI.message ""
    
    # Verify workspace exists (from our current fastlane/ directory)
    ruby_workspace_path = "#{ruby_ios_path}/smbmobile.xcworkspace"
    fastlane_workspace_path = "#{fastlane_ios_path}/smbmobile.xcworkspace"
    absolute_workspace_path = File.expand_path(ruby_workspace_path)
    
    UI.message "   - Looking for workspace at: #{ruby_workspace_path} (for verification)"
    UI.message "   - Fastlane will use: #{fastlane_workspace_path} (after chdir to project root)"
    UI.message "   - Absolute path: #{absolute_workspace_path}"
    UI.message "   - Workspace exists: #{File.exist?(ruby_workspace_path)}"
    
    if File.exist?(ruby_workspace_path)
      UI.success "âœ… Workspace found: #{ruby_workspace_path}"
    else
      UI.error "âŒ Workspace not found at: #{ruby_workspace_path}"
      UI.error ""
      UI.error "Troubleshooting information:"
      UI.error "1. Check if Expo prebuild completed successfully"
      UI.error "2. Check if pod install completed successfully"
      UI.error "3. Verify the workspace was created in the correct location"
      UI.error ""
      UI.error "iOS directory structure:"
      system("ls -la #{ruby_ios_path}/ 2>/dev/null || echo 'Cannot list #{ruby_ios_path}/ directory'")
      UI.user_error! "âŒ Workspace not found at: #{ruby_workspace_path}"
    end
    
    # Verify scheme exists
    UI.message "   - Verifying scheme..."
    schemes = sh("xcodebuild -workspace #{ruby_workspace_path} -list | grep 'Schemes:' -A 100 || true", log: false)
    UI.message "Available schemes:\n#{schemes}"
    
    # Build configuration
    # build_ios_app also changes to project root, so use ios/ paths
    build_config = {
      workspace: "ios/smbmobile.xcworkspace",
      scheme: "smbmobile",
      configuration: "Release",
      export_method: "app-store",
      output_directory: "ios/build",
      output_name: "smbmobile.ipa",
      destination: "generic/platform=iOS",
      sdk: "iphoneos",
      export_options: {
        method: "app-store",
        provisioningProfiles: {
          "com.insighture.smbmobile" => "match AppStore com.insighture.smbmobile"
        },
        teamID: "96W7U4JYV4"
      },
      xcargs: "ONLY_ACTIVE_ARCH=NO ENABLE_BITCODE=NO COMPILER_INDEX_STORE_ENABLE=NO CLANG_ENABLE_MODULE_VERIFIER=NO CLANG_ENABLE_EXPLICIT_MODULES=NO -allowProvisioningUpdates",
      skip_profile_detection: true,
      buildlog_path: "fastlane/logs",
      verbose: true
    }
    
    UI.message ""
    UI.important "ğŸ”¨ Starting xcodebuild..."
    UI.message "This may take several minutes..."
    UI.message "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    begin
      # Build and archive
      build_ios_app(build_config)
      
      UI.message "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      UI.success "âœ… Build completed successfully!"
      
      # Verify IPA was created (from our fastlane/ directory)
      ipa_path = "../ios/build/smbmobile.ipa"
      if File.exist?(ipa_path)
        ipa_size = File.size(ipa_path) / 1024.0 / 1024.0
        UI.success "âœ… IPA created: #{ipa_path} (#{ipa_size.round(2)} MB)"
      else
        UI.error "âš ï¸  IPA file not found at expected location: #{ipa_path}"
        UI.error "Checking alternate location..."
        alt_path = "ios/build/smbmobile.ipa"
        if File.exist?(alt_path)
          ipa_size = File.size(alt_path) / 1024.0 / 1024.0
          UI.success "âœ… IPA found at: #{alt_path} (#{ipa_size.round(2)} MB)"
        end
      end
    rescue => ex
      UI.message "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      UI.error "âŒ BUILD FAILED!"
      UI.error "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      UI.error "Error message: #{ex.message}"
      UI.error ""
      UI.error "Stack trace:"
      ex.backtrace.first(10).each { |line| UI.error "  #{line}" }
      UI.error ""
      UI.error "Check the build logs at: ./fastlane/logs"
      UI.error "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      raise ex
    end

    UI.message ""
    UI.message "ğŸ“‹ Step 7/8: Uploading to TestFlight"
    UI.message "   - App Identifier: com.insighture.smbmobile"
    UI.message "   - Skip processing wait: true"
    
    # Upload to TestFlight with auto-retry on duplicate build errors
    max_retries = 3
    retry_count = 0
    upload_success = false
    
    while retry_count < max_retries && !upload_success
      begin
        UI.message "   - Upload attempt #{retry_count + 1}/#{max_retries}"
        
        upload_to_testflight(
          skip_waiting_for_build_processing: true,
          api_key: api_key
        )
        
        upload_success = true
        UI.success "âœ… Successfully uploaded to TestFlight!"
        
      rescue => ex
        if ex.message.include?("bundle version must be higher") || ex.message.include?("DUPLICATE")
          retry_count += 1
          UI.warning "âš ï¸  Duplicate build number detected"
          
          if retry_count < max_retries
            UI.message "   - Incrementing build number and retrying..."
            project_path = "ios/smbmobile.xcodeproj"
            current_build = get_build_number(xcodeproj: project_path)
            new_build = current_build.to_i + 1
            UI.message "   - New build number: #{new_build}"
            
            increment_build_number(
              xcodeproj: project_path,
              build_number: new_build
            )
            
            UI.message "   - Rebuilding with new build number..."
            build_ios_app(build_config)
          else
            UI.error "âŒ Max retries reached for duplicate build"
            raise ex
          end
        else
          UI.error "âŒ Upload to TestFlight failed"
          UI.error "Error: #{ex.message}"
          raise ex
        end
      end
    end

    UI.message ""
    UI.message "ğŸ“‹ Step 8/8: Generating changelog"
    changelog_from_git_commits
    
    UI.message ""
    UI.success "ğŸ‰ ============================================="
    UI.success "ğŸ‰ iOS QA Release Completed Successfully!"
    UI.success "ğŸ‰ ============================================="
    project_path = "ios/smbmobile.xcodeproj"
    UI.success "   Version: #{get_version_number(xcodeproj: project_path)}"
    UI.success "   Build: #{get_build_number(xcodeproj: project_path)}"
    UI.success "   IPA: ios/build/smbmobile.ipa"
    UI.success "============================================="
  end

  desc "Submit a new staging build to TestFlight"
  lane :stg_release do
    increment_version_number(
      xcodeproj: "ios/smbmobile.xcodeproj",
      bump_type: "patch"
    )
    increment_build_number(
      xcodeproj: "ios/smbmobile.xcodeproj"
    )

    build_ios_app(
      workspace: "ios/smbmobile.xcworkspace",
      scheme: "smbmobile",
      export_method: "app-store",
      export_options: {
        method: "app-store",
        provisioningProfiles: {
          "com.insighture.smbmobile" => "match AppStore com.insighture.smbmobile"
        }
      },
      output_directory: "ios/build",
      output_name: "smbmobile.ipa",
      team_id: ENV['APPLE_TEAM_ID'] || "96W7U4JYV4"
    )

    upload_to_testflight(
      skip_waiting_for_build_processing: true
    )

    changelog_from_git_commits
  end

  desc "Submit a new production build to App Store"
  lane :production_release do
    increment_version_number(
      xcodeproj: "ios/smbmobile.xcodeproj",
      bump_type: "patch"
    )
    increment_build_number(
      xcodeproj: "ios/smbmobile.xcodeproj"
    )

    build_ios_app(
      workspace: "ios/smbmobile.xcworkspace",
      scheme: "smbmobile",
      export_method: "app-store",
      export_options: {
        method: "app-store",
        provisioningProfiles: {
          "com.insighture.smbmobile" => "match AppStore com.insighture.smbmobile"
        }
      },
      output_directory: "ios/build",
      output_name: "smbmobile.ipa",
      team_id: ENV['APPLE_TEAM_ID'] || "96W7U4JYV4"
    )

    upload_to_app_store(
      skip_metadata: true,
      skip_screenshots: true,
      precheck_include_in_app_purchases: false
    )

    changelog_from_git_commits
  end

  desc "Submit a new production build to App Store (legacy)"
  lane :release do
    increment_version_number(
      xcodeproj: "ios/smbmobile.xcodeproj",
      bump_type: "patch"
    )
    increment_build_number(
      xcodeproj: "ios/smbmobile.xcodeproj"
    )

    build_ios_app(
      workspace: "ios/smbmobile.xcworkspace",
      scheme: "smbmobile",
      export_method: "app-store",
      export_options: {
        method: "app-store",
        provisioningProfiles: {
          "com.insighture.smbmobile" => "match AppStore com.insighture.smbmobile"
        }
      },
      output_directory: "ios/build",
      output_name: "smbmobile.ipa",
      team_id: ENV['APPLE_TEAM_ID'] || "96W7U4JYV4"
    )

    upload_to_app_store(
      skip_metadata: true,
      skip_screenshots: true,
      precheck_include_in_app_purchases: false
    )

    changelog_from_git_commits
  end
end
