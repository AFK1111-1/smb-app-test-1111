# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tool

default_platform(:android)

platform :android do
  desc "Build Android debug APK for development"
  lane :dev_build do
    gradle(task: "clean assembleRelease", project_dir: "./android", properties: {
      "android.injected.signing.store.file" => "#{Dir.pwd}/../credentials/android/release.keystore",
      "android.injected.signing.store.password" => ENV['ANDROID_KEYSTORE_PASSWORD'],
      "android.injected.signing.key.alias" => ENV['ANDROID_KEY_ALIAS'],
      "android.injected.signing.key.password" => ENV['ANDROID_KEY_PASSWORD']
    })
  end

  desc "Submit a new internal test build to play store"
  lane :qa_release do
    previous_build_number = google_play_track_version_codes(
      track: "internal",
      json_key: "credentials/android/google-play-service-key.json"
    )[0]

    increment_version_name(
      gradle_file_path: "android/app/build.gradle"
    )
    increment_version_code(
      gradle_file_path: "android/app/build.gradle",
      version_code: previous_build_number + 1
    )

    gradle(task: "clean bundleRelease", project_dir: "./android", properties: {
      "android.injected.signing.store.file" => "#{Dir.pwd}/../credentials/android/release.keystore",
      "android.injected.signing.store.password" => ENV['ANDROID_KEYSTORE_PASSWORD'],
      "android.injected.signing.key.alias" => ENV['ANDROID_KEY_ALIAS'],
      "android.injected.signing.key.password" => ENV['ANDROID_KEY_PASSWORD']
    })

    upload_to_play_store(
      track: 'internal',
      json_key: "credentials/android/google-play-service-key.json",
      aab: "android/app/build/outputs/bundle/release/app-release.aab"
    )

    changelog_from_git_commits
  end

  desc "Submit a new staging build to play store"
  lane :stg_release do
    increment_version_name(
      gradle_file_path: "android/app/build.gradle"
    )
    increment_version_code(
      gradle_file_path: "android/app/build.gradle"
    )

    gradle(task: "clean bundleRelease", project_dir: "./android", properties: {
      "android.injected.signing.store.file" => "#{Dir.pwd}/../credentials/android/release.keystore",
      "android.injected.signing.store.password" => ENV['ANDROID_KEYSTORE_PASSWORD'],
      "android.injected.signing.key.alias" => ENV['ANDROID_KEY_ALIAS'],
      "android.injected.signing.key.password" => ENV['ANDROID_KEY_PASSWORD']
    })

    upload_to_play_store(
      track: 'closed',
      json_key: "credentials/android/google-play-service-key.json",
      aab: "android/app/build/outputs/bundle/release/app-release.aab"
    )

    changelog_from_git_commits
  end

  desc "Submit a new production build to play store"
  lane :production_release do
    increment_version_name(
      gradle_file_path: "android/app/build.gradle"
    )
    increment_version_code(
      gradle_file_path: "android/app/build.gradle"
    )

    gradle(task: "clean bundleRelease", project_dir: "./android", properties: {
      "android.injected.signing.store.file" => "#{Dir.pwd}/../credentials/android/release.keystore",
      "android.injected.signing.store.password" => ENV['ANDROID_KEYSTORE_PASSWORD'],
      "android.injected.signing.key.alias" => ENV['ANDROID_KEY_ALIAS'],
      "android.injected.signing.key.password" => ENV['ANDROID_KEY_PASSWORD']
    })

    upload_to_play_store(
      track: 'production',
      release_status: "draft",
      json_key: "credentials/android/google-play-service-key.json",
      aab: "android/app/build/outputs/bundle/release/app-release.aab"
    )
  end
end

platform :ios do

  desc "Build iOS simulator app for development"
  lane :dev_build do
    build_ios_app(
      workspace: "ios/smbmobile.xcworkspace",
      scheme: "smbmobile",
      sdk: "iphonesimulator",
      configuration: "Debug",
      derived_data_path: "ios/build",
      output_directory: "ios/build",
      output_name: "smbmobile.app"
    )
  end

  desc "Submit a new QA build to TestFlight"
  lane :qa_release do
    # Setup App Store Connect API authentication
    # ðŸ”‘ Best Practice: Use a helper method or a before_all block to avoid repetition
    api_key = app_store_connect_api_key(
      key_id: ENV['APP_STORE_CONNECT_API_KEY_ID'],
      issuer_id: ENV['APP_STORE_CONNECT_ISSUER_ID'],
      # Ensure consistent path resolution relative to fastlane folder
      key_filepath: "#{Dir.pwd}/../credentials/ios/AuthKey.p8"
    )

    # Fetch App Store provisioning profiles and certificates from private Git repo
    match(
      type: "appstore",
      app_identifier: "com.insighture.smbmobile",
      git_url: "git@github.com:insighture/smb-mobile-fastlane.git",
      api_key: api_key,
      keychain_password: ENV['KEYCHAIN_PASSWORD'],
      keychain_name: ENV['KEYCHAIN_NAME']
    )
    
    # Increment version number
    increment_version_number(
      xcodeproj: "ios/smbmobile.xcodeproj",
      bump_type: "patch"
    )
    
    # Get latest TestFlight build and increment
    begin
      latest_build = latest_testflight_build_number(
        app_identifier: "com.insighture.smbmobile",
        api_key: api_key,
        # ðŸ”‘ Explicitly skip waiting for processing to get the latest version number quickly
        wait_for_uploaded_build: false 
      )
      increment_build_number(
        xcodeproj: "ios/smbmobile.xcodeproj",
        build_number: latest_build.to_i + 1
      )
    rescue
      # Fallback to current build number + 1 if fetching the latest failed
      increment_build_number(xcodeproj: "ios/smbmobile.xcodeproj")
    end

    # Build configuration
    build_config = {
      workspace: "ios/smbmobile.xcworkspace",
      scheme: "smbmobile",
      configuration: "Release",
      export_method: "app-store",
      output_directory: "./ios/build",
      output_name: "smbmobile.ipa",
      destination: "generic/platform=iOS",
      export_options: {
        method: "app-store",
        # Explicitly setting provisioning profile name is a strong practice with match
        provisioningProfiles: {
          "com.insighture.smbmobile" => "match AppStore com.insighture.smbmobile"
        },
        teamID: "96W7U4JYV4"
      },
      # Removed unnecessary xcargs, added clean build flag
      clean: true, 
      skip_profile_detection: true
    }

    # Build and archive
    build_ios_app(build_config)

    # ðŸš€ Polished Upload and Retry Logic
    # Fastlane recommends encapsulating retries clearly.
    # The default TestFlight action already has a retry mechanism, but custom logic is fine.
    max_retries = 3
    retry_count = 0
    upload_success = false
    
    while retry_count < max_retries && !upload_success
      begin
        UI.message("Attempting upload to TestFlight (Attempt #{retry_count + 1} of #{max_retries}).")
        upload_to_testflight(
          skip_waiting_for_build_processing: true,
          api_key: api_key # Explicitly passing api_key
        )
        upload_success = true
      rescue => ex
        # Check for the common "The build is a duplicate" or similar versioning errors
        if ex.message.include?("bundle version must be higher") || ex.message.include?("DUPLICATE")
          retry_count += 1
          
          if retry_count < max_retries
            current_build = get_build_number(xcodeproj: "ios/smbmobile.xcodeproj")
            new_build_number = current_build.to_i + 1
            UI.important("Duplicate build number detected. Incrementing build number to #{new_build_number} and rebuilding...")

            # Increment, rebuild, and retry
            increment_build_number(
              xcodeproj: "ios/smbmobile.xcodeproj",
              build_number: new_build_number
            )
            build_ios_app(build_config)
          else
            UI.error("Failed to upload after #{max_retries} attempts.")
            raise ex
          end
        else
          # Re-raise non-duplicate errors immediately
          raise ex
        end
      end
    end

    changelog_from_git_commits
  end

  desc "Submit a new staging build to TestFlight"
  lane :stg_release do
    api_key = app_store_connect_api_key(
      key_id: ENV['APP_STORE_CONNECT_API_KEY_ID'],
      issuer_id: ENV['APP_STORE_CONNECT_ISSUER_ID'],
      key_filepath: "../credentials/ios/AuthKey.p8"
    )

    match(
      type: "appstore",
      app_identifier: "com.insighture.smbmobile",
      git_url: "git@github.com:insighture/smb-mobile-fastlane.git",
      api_key: api_key,
      keychain_password: ENV['KEYCHAIN_PASSWORD'],
      keychain_name: ENV['KEYCHAIN_NAME']
    )

    increment_version_number(
      xcodeproj: "ios/smbmobile.xcodeproj",
      bump_type: "patch"
    )
    
    latest_build = latest_testflight_build_number(
      app_identifier: "com.insighture.smbmobile",
      api_key: api_key,
      wait_for_uploaded_build: false
    ) rescue 0
    
    increment_build_number(
      xcodeproj: "ios/smbmobile.xcodeproj",
      build_number: latest_build.to_i + 1
    )

    build_ios_app(
      workspace: "ios/smbmobile.xcworkspace",
      scheme: "smbmobile",
      configuration: "Release",
      export_method: "app-store",
      export_options: {
        method: "app-store",
        provisioningProfiles: {
          "com.insighture.smbmobile" => "match AppStore com.insighture.smbmobile"
        }
      },
      output_directory: "ios/build",
      output_name: "smbmobile.ipa",
      team_id: ENV['APPLE_TEAM_ID'] || "96W7U4JYV4",
      clean: true
    )

    upload_to_testflight(
      skip_waiting_for_build_processing: true,
      api_key: api_key
    )

    changelog_from_git_commits
  end

  desc "Submit a new production build to App Store"
  lane :production_release do
    api_key = app_store_connect_api_key(
      key_id: ENV['APP_STORE_CONNECT_API_KEY_ID'],
      issuer_id: ENV['APP_STORE_CONNECT_ISSUER_ID'],
      key_filepath: "../credentials/ios/AuthKey.p8"
    )
    
    match(
      type: "appstore",
      app_identifier: "com.insighture.smbmobile",
      git_url: "git@github.com:insighture/smb-mobile-fastlane.git",
      api_key: api_key,
      keychain_password: ENV['KEYCHAIN_PASSWORD'],
      keychain_name: ENV['KEYCHAIN_NAME']
    )

    increment_version_number(
      xcodeproj: "ios/smbmobile.xcodeproj",
      bump_type: "patch"
    )
    
    latest_build = latest_testflight_build_number(
      app_identifier: "com.insighture.smbmobile",
      api_key: api_key,
      wait_for_uploaded_build: false
    ) rescue 0

    increment_build_number(
      xcodeproj: "ios/smbmobile.xcodeproj",
      build_number: latest_build.to_i + 1
    )

    build_ios_app(
      workspace: "ios/smbmobile.xcworkspace",
      scheme: "smbmobile",
      configuration: "Release",
      export_method: "app-store",
      export_options: {
        method: "app-store",
        provisioningProfiles: {
          "com.insighture.smbmobile" => "match AppStore com.insighture.smbmobile"
        }
      },
      output_directory: "ios/build",
      output_name: "smbmobile.ipa",
      team_id: ENV['APPLE_TEAM_ID'] || "96W7U4JYV4",
      clean: true
    )

    # ðŸ”‘ Best Practice: Use the dedicated App Store upload action 
    # and pass the API key explicitly.
    upload_to_app_store(
      skip_metadata: true,
      skip_screenshots: true,
      precheck_include_in_app_purchases: false,
      api_key: api_key
    )

    changelog_from_git_commits
  end
end