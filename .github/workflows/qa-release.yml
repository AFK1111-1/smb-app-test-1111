name: QA Release Build

on:
  workflow_dispatch:

jobs:
  qa-build:
    runs-on: macos-15
    name: Build QA Release

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Ruby and Fastlane
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: Install Fastlane
        run: |
          gem install fastlane
          bundle install

      - name: Setup environment variables
        run: |
          echo "KINDE_DOMAIN=${{ vars.KINDE_DOMAIN }}" >> .env
          echo "KINDE_CLIENT_ID=${{ vars.KINDE_CLIENT_ID }}" >> .env
          echo "KINDE_SCOPES=${{ vars.KINDE_SCOPES }}" >> .env
          echo "PUBLIC_API_URL=${{ vars.PUBLIC_API_URL }}" >> .env
          echo "KINDE_AUDIENCE=${{ vars.KINDE_AUDIENCE }}" >> .env

      - name: Create credentials directories
        run: |
          mkdir -p credentials/android
          mkdir -p credentials/ios

      # - name: Setup Android Keystore
      #   run: |
      #     echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > credentials/android/release.keystore

      # - name: Setup Google Play Service Key
      #   run: |
      #     echo "${{ secrets.GOOGLE_PLAY_SERVICE_KEY }}" | base64 --decode > credentials/android/google-play-service-key.json

      # - name: Setup Google Services JSON for Android
      #   run: |
      #     echo "${{ secrets.ANDROID_GOOGLE_SERVICES_JSON }}" | base64 --decode > google-services.json

      # - name: Expo Prebuild for Android
      #   run: npm run prebuild -- --platform android --clean

      # - name: Build and Release Android
      #   run: fastlane android qa_release
      #   env:
      #     ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
      #     ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
      #     ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}

      # - name: Upload Android Release AAB
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: android-release-aab
      #     path: android/app/build/outputs/bundle/release/app-release.aab
      #     retention-days: 30

      - name: Setup Apple API Key
        run: |
          # Remove any whitespace and newlines from the base64 content
          base64_content=$(echo "${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}" | \
            sed 's/-----BEGIN PRIVATE KEY-----//g' | \
            sed 's/-----END PRIVATE KEY-----//g' | \
            tr -d ' \n\r\t')

          # Create the properly formatted P8 file
          echo "-----BEGIN PRIVATE KEY-----" > credentials/ios/AuthKey.p8
          echo "$base64_content" | fold -w 64 >> credentials/ios/AuthKey.p8
          echo "-----END PRIVATE KEY-----" >> credentials/ios/AuthKey.p8

      - name: Setup Google Service Info Plist for iOS
        run: |
          echo "${{ secrets.IOS_GOOGLE_SERVICE_INFO_PLIST }}" | base64 --decode > GoogleService-Info.plist

      - name: Expo Prebuild for iOS
        run: npm run prebuild -- --platform ios --clean
      
      - name: Move GoogleService-Info.plist to iOS directory
        run: |
          if [ -f GoogleService-Info.plist ]; then
            cp GoogleService-Info.plist ios/GoogleService-Info.plist
            echo "âœ… GoogleService-Info.plist copied to ios directory"
          else
            echo "âš ï¸ GoogleService-Info.plist not found in root"
          fi

      - name: Install CocoaPods dependencies
        run: |
          cd ios
          echo "ğŸ” CocoaPods version:"
          pod --version
          
          echo ""
          echo "ğŸ“¦ Installing pods..."
          pod install --verbose
          
          echo ""
          echo "âœ… Pod installation complete. Checking workspace:"
          ls -la *.xcworkspace || echo "No workspace found"
          
          echo ""
          echo "ğŸ“‹ Pods installed:"
          ls -la Pods/ | head -n 20
          cd ..

      - name: Setup SSH for Fastlane Match
        run: |
          mkdir -p ~/.ssh

          # Check if the key is already in PEM format or base64 encoded
          if echo "${{ secrets.FASTLANE_MATCH_DEPLOY_KEY }}" | head -c 5 | grep -q "^-----"; then
            echo "${{ secrets.FASTLANE_MATCH_DEPLOY_KEY }}" > ~/.ssh/id_rsa
          else
            echo "${{ secrets.FASTLANE_MATCH_DEPLOY_KEY }}" | base64 --decode > ~/.ssh/id_rsa
          fi

          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan github.com >> ~/.ssh/known_hosts

      - name: Setup Xcode 16.1
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.1'

      - name: Setup Xcode First Launch and Install iOS 18.1 Runtime
        run: |
          echo "ğŸ”§ Running Xcode first launch..."
          sudo xcodebuild -runFirstLaunch
          sudo xcodebuild -license accept || echo "License already accepted"
          
          echo "ğŸ“± Available iOS runtimes before download:"
          xcrun simctl list runtimes | grep iOS || echo "No iOS runtimes found"
          
          echo "â¬‡ï¸ Downloading iOS runtime..."
          sudo xcodebuild -downloadPlatform iOS || echo "Download command completed"
          
          echo "â³ Waiting for installation to complete..."
          sleep 60
          
          echo "âœ… Available iOS runtimes after download:"
          xcrun simctl list runtimes | grep iOS || echo "No iOS runtimes found"
          
          echo "ğŸ“‹ Available SDKs:"
          xcodebuild -showsdks

      - name: Create temporary keychain
        run: |
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)
          KEYCHAIN_NAME="build.keychain"
          echo "KEYCHAIN_PASSWORD=$KEYCHAIN_PASSWORD" >> $GITHUB_ENV
          echo "KEYCHAIN_NAME=$KEYCHAIN_NAME" >> $GITHUB_ENV
          
          # Delete existing keychain if present
          security delete-keychain "$KEYCHAIN_NAME" 2>/dev/null || true
          
          # Create new keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"
          
          # Add to search list
          EXISTING_KEYCHAINS=$(security list-keychains -d user | tr -d '"' | tr '\n' ' ')
          security list-keychains -d user -s "$KEYCHAIN_NAME" $EXISTING_KEYCHAINS
          
          # Set as default and unlock
          security default-keychain -s "$KEYCHAIN_NAME"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"
          
          # Set keychain timeout (1 hour)
          security set-keychain-settings -t 3600 -u "$KEYCHAIN_NAME"
          
          # Allow codesigning to access keychain
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME" 2>/dev/null || true

      - name: Unlock keychain
        run: |
          security unlock-keychain -p "${{ env.KEYCHAIN_PASSWORD }}" "${{ env.KEYCHAIN_NAME }}"
      
      - name: Verify iOS Project Setup
        run: |
          echo "ğŸ“‚ iOS project structure:"
          ls -la ios/ || echo "ios directory not found"
          
          echo ""
          echo "ğŸ“± Checking for GoogleService-Info.plist:"
          ls -la ios/GoogleService-Info.plist || echo "GoogleService-Info.plist not found in ios/"
          
          echo ""
          echo "ğŸ” Checking for provisioning profiles:"
          ls -la ~/Library/MobileDevice/Provisioning\ Profiles/ || echo "No provisioning profiles found"
          
          echo ""
          echo "ğŸ”‘ Checking identities in keychain:"
          security find-identity -v -p codesigning "${{ env.KEYCHAIN_NAME }}" || echo "No identities found"
          
          echo ""
          echo "ğŸ“¦ Checking workspace:"
          ls -la ios/*.xcworkspace || echo "No workspace found"
          ls -la ios/*.xcodeproj || echo "No project found"
          
          echo ""
          echo "ğŸ” Checking Xcode build settings:"
          xcodebuild -workspace ios/smbmobile.xcworkspace -scheme smbmobile -showBuildSettings | grep -E "CODE_SIGN|PROVISIONING_PROFILE|TEAM" || echo "Could not retrieve build settings"
          
          echo ""
          echo "ğŸ§ª Validating project configuration:"
          xcodebuild -workspace ios/smbmobile.xcworkspace -scheme smbmobile -configuration Release -destination "generic/platform=iOS" clean || echo "Clean validation completed"

      - name: Build and Release iOS
        run: |
          echo "ğŸš€ Starting iOS build..."
          fastlane ios qa_release 2>&1 | tee build.log || {
            echo "âŒ Build failed, showing last 200 lines of output:"
            tail -n 200 build.log
            exit 1
          }
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ env.KEYCHAIN_PASSWORD }}
          KEYCHAIN_NAME: ${{ env.KEYCHAIN_NAME }}
          FASTLANE_XCODEBUILD_SETTINGS_TIMEOUT: 60
          FASTLANE_XCODEBUILD_SETTINGS_RETRIES: 6

      - name: Upload Build Logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: build-logs
          path: |
            ~/Library/Logs/gym/*.log
            build.log
          retention-days: 7
          if-no-files-found: ignore

      - name: Cleanup keychain
        if: always()
        run: |
          security delete-keychain "${{ env.KEYCHAIN_NAME }}" 2>/dev/null || true

      - name: Upload iOS Release IPA
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: ios-release-ipa
          path: ios/build/smbmobile.ipa
          retention-days: 30

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        if: success()
        with:
          body: |
            ## QA Release v${{ github.run_number }}
            
            ### ğŸ“± Build Artifacts
            - **ğŸ¤– Android AAB**: Download from Actions tab
            - **ğŸ iOS IPA**: Download from Actions tab
            
            ### ğŸ“‹ Build Details
            - **Commit**: ${{ github.sha }}
            - **Branch**: ${{ github.ref_name }}
            - **Build Number**: ${{ github.run_number }}
            - **Xcode**: 16.1 with iOS 18.1 runtime
            
            ### ğŸš€ Deployment
            - Android: Internal track on Google Play
            - iOS: TestFlight
          draft: false
          tag_name: qa-v${{ github.run_number }}
          prerelease: true
          name: QA Release v${{ github.run_number }}
          token: ${{ secrets.GITHUB_TOKEN }}