name: QA Release Build

on:
  workflow_dispatch:

jobs:
  qa-build:
    runs-on: macos-14
    name: Build QA Release
    permissions: write-all

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          cache: npm
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Install Ruby and Fastlane
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: Install Fastlane
        run: |
          gem install fastlane
          bundle install

      - name: Setup environment variables
        run: |
          echo "KINDE_DOMAIN=${{ vars.KINDE_DOMAIN }}" >> .env
          echo "KINDE_CLIENT_ID=${{ vars.KINDE_CLIENT_ID }}" >> .env
          echo "KINDE_SCOPES=${{ vars.KINDE_SCOPES }}" >> .env
          echo "PUBLIC_API_URL=${{ vars.PUBLIC_API_URL }}" >> .env
          echo "KINDE_AUDIENCE=${{ vars.KINDE_AUDIENCE }}" >> .env

      - name: Create credentials directories
        run: |
          mkdir -p credentials/android
          mkdir -p credentials/ios

      # - name: Setup Android Keystore
      #   run: >
      #     echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode >
      #     credentials/android/release.keystore

      # - name: Setup Google Play Service Key
      #   run: |
      #     echo "$GOOGLE_PLAY_SERVICE_KEY" | base64 --decode > credentials/android/google-play-service-key.json
      #   env:
      #     GOOGLE_PLAY_SERVICE_KEY: ${{ secrets.GOOGLE_PLAY_SERVICE_KEY }}

      # - name: Setup Google Services JSON for Android
      #   run: >
      #     echo "${{ secrets.ANDROID_GOOGLE_SERVICES_JSON }}" | base64 --decode >
      #     google-services.json

      # - name: Expo Prebuild for Android
      #   run: npm run prebuild -- --platform android --clean

      # - name: Build and Release Android
      #   run: fastlane android qa_release
      #   env:
      #     ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
      #     ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
      #     ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}

      # - name: Upload Android Release AAB
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: android-release-aab
      #     path: android/app/build/outputs/bundle/release/app-release.aab
      #     retention-days: '30'

      - name: Setup Apple API Key
        run: |
          base64_content=$(echo "$APP_STORE_CONNECT_API_KEY_BASE64" | \
            sed 's/-----BEGIN PRIVATE KEY-----//g' | \
            sed 's/-----END PRIVATE KEY-----//g' | \
            tr -d ' \n\r\t')
          
          echo "-----BEGIN PRIVATE KEY-----" > credentials/ios/AuthKey.p8
          echo "$base64_content" | fold -w 64 >> credentials/ios/AuthKey.p8
          echo "-----END PRIVATE KEY-----" >> credentials/ios/AuthKey.p8
        env:
          APP_STORE_CONNECT_API_KEY_BASE64: ${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}

      - name: Setup Google Service Info Plist for iOS
        run: >
          echo "${{ secrets.IOS_GOOGLE_SERVICE_INFO_PLIST }}" | base64 --decode >
          GoogleService-Info.plist

      - name: Expo Prebuild for iOS
        run: npm run prebuild -- --platform ios --clean
      
      - name: Move GoogleService-Info.plist to iOS directory
        run: |
          if [ -f GoogleService-Info.plist ]; then
            cp GoogleService-Info.plist ios/GoogleService-Info.plist
            echo "âœ… GoogleService-Info.plist copied to ios/"
          else
            echo "âš ï¸ GoogleService-Info.plist not found!"
          fi

      - name: Install CocoaPods dependencies
        run: |
          cd ios
          pod install
          cd ..
      
      - name: Configure Pod Targets Code Signing
        run: |
          cd ios
          cat > fix_pod_signing.rb << 'RUBY_SCRIPT'
          require 'xcodeproj'
          
          project_path = 'Pods/Pods.xcodeproj'
          project = Xcodeproj::Project.open(project_path)
          
          team_id = '96W7U4JYV4'
          min_ios_version = '15.1'
          
          project.targets.each do |target|
            target.build_configurations.each do |config|
              # Set team ID and deployment target for all pods
              config.build_settings['DEVELOPMENT_TEAM'] = team_id
              config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = min_ios_version
              
              # Aggressively disable all forms of precompilation and module caching
              config.build_settings['ENABLE_PRECOMPILED_HEADERS'] = 'NO'
              config.build_settings['GCC_PRECOMPILE_PREFIX_HEADER'] = 'NO'
              config.build_settings['CLANG_ENABLE_MODULE_DEBUGGING'] = 'NO'
              config.build_settings['CLANG_ENABLE_MODULES'] = 'YES'
              config.build_settings['SWIFT_COMPILATION_MODE'] = 'wholemodule'
              config.build_settings['SWIFT_OPTIMIZATION_LEVEL'] = '-Owholemodule'
              
              # Disable code signing for resource bundles and privacy manifests
              if target.name.include?('_Privacy') || 
                 target.name.include?('_privacy') ||
                 target.name.include?('Resources') || 
                 target.name.include?('_resources')
                config.build_settings['CODE_SIGNING_REQUIRED'] = 'NO'
                config.build_settings['CODE_SIGNING_ALLOWED'] = 'NO'
                config.build_settings['CODE_SIGN_IDENTITY'] = ''
              end
            end
          end
          
          project.save
          puts "âœ… Updated #{project.targets.count} Pod targets"
          RUBY_SCRIPT
          
          ruby fix_pod_signing.rb
          cd ..
      
      - name: Configure Main Project Build Settings
        run: |
          cd ios
          cat > fix_main_project.rb << 'RUBY_SCRIPT'
          require 'xcodeproj'
          
          project_path = 'smbmobile.xcodeproj'
          project = Xcodeproj::Project.open(project_path)
          
          project.targets.each do |target|
            if target.name == 'smbmobile'
              target.build_configurations.each do |config|
                # Disable precompilation for the main target as well
                config.build_settings['ENABLE_PRECOMPILED_HEADERS'] = 'NO'
                config.build_settings['GCC_PRECOMPILE_PREFIX_HEADER'] = 'NO'
                config.build_settings['CLANG_ENABLE_MODULE_DEBUGGING'] = 'NO'
              end
            end
          end
          
          project.save
          puts "âœ… Updated main project build settings"
          RUBY_SCRIPT
          
          ruby fix_main_project.rb
          cd ..
      
      - name: Verify Build Settings
        run: |
          cd ios
          echo "ğŸ” Checking RNFBApp Pod build settings..."
          xcodebuild -project Pods/Pods.xcodeproj -target RNFBApp -showBuildSettings -configuration Release 2>/dev/null | grep -E "ENABLE_PRECOMPILED_HEADERS|GCC_PRECOMPILE_PREFIX_HEADER|CLANG_ENABLE_MODULE_DEBUGGING|DEVELOPMENT_TEAM|IPHONEOS_DEPLOYMENT_TARGET" || echo "âš ï¸ Could not find RNFBApp target"
          echo ""
          echo "ğŸ” Checking main project build settings..."
          xcodebuild -workspace smbmobile.xcworkspace -scheme smbmobile -showBuildSettings -configuration Release 2>/dev/null | grep -E "ENABLE_PRECOMPILED_HEADERS|GCC_PRECOMPILE_PREFIX_HEADER|CLANG_ENABLE_MODULE_DEBUGGING" | head -n 10 || echo "âš ï¸ Could not retrieve main project settings"
          cd ..

      - name: Setup SSH for Fastlane Match
        run: |
          mkdir -p ~/.ssh
          if echo "$FASTLANE_MATCH_DEPLOY_KEY" | head -c 5 | grep -q "^-----"; then
            echo "$FASTLANE_MATCH_DEPLOY_KEY" > ~/.ssh/id_rsa
          else
            echo "$FASTLANE_MATCH_DEPLOY_KEY" | base64 --decode > ~/.ssh/id_rsa
          fi
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan github.com >> ~/.ssh/known_hosts
        env:
          FASTLANE_MATCH_DEPLOY_KEY: ${{ secrets.FASTLANE_MATCH_DEPLOY_KEY }}

      - name: Setup Xcode 15.4
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.4'

      - name: Setup Xcode First Launch
        run: |
          sudo xcodebuild -runFirstLaunch
          sudo xcodebuild -license accept || echo "License already accepted"
          echo "ğŸ“± Available iOS runtimes:"
          xcrun simctl list runtimes | grep iOS || echo "No iOS runtimes found"
          echo "ğŸ“‹ Available SDKs:"
          xcodebuild -showsdks

      - name: Create temporary keychain
        run: |
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)
          KEYCHAIN_NAME="build.keychain"
          echo "KEYCHAIN_PASSWORD=$KEYCHAIN_PASSWORD" >> $GITHUB_ENV
          echo "KEYCHAIN_NAME=$KEYCHAIN_NAME" >> $GITHUB_ENV
          security delete-keychain "$KEYCHAIN_NAME" 2>/dev/null || true
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"
          EXISTING_KEYCHAINS=$(security list-keychains -d user | tr -d '"' | tr '\n' ' ')
          security list-keychains -d user -s "$KEYCHAIN_NAME" $EXISTING_KEYCHAINS
          security default-keychain -s "$KEYCHAIN_NAME"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"
          security set-keychain-settings -t 3600 -u "$KEYCHAIN_NAME"
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME" 2>/dev/null || true

      - name: Unlock keychain
        run: |
          security unlock-keychain -p "${{ env.KEYCHAIN_PASSWORD }}" "${{ env.KEYCHAIN_NAME }}"
      
      - name: Clean Xcode Build Cache
        run: |
          echo "ğŸ§¹ Cleaning Xcode derived data and module cache..."
          rm -rf ~/Library/Developer/Xcode/DerivedData/*
          rm -rf ~/Library/Caches/org.swift.swiftpm
          echo "âœ… Cache cleaned"
      
      - name: Verify iOS Project Setup
        run: |
          echo "ğŸ“± Checking GoogleService-Info.plist..."
          ls -lh ios/GoogleService-Info.plist || echo "âŒ Missing GoogleService-Info.plist"
          if [ -f ios/GoogleService-Info.plist ]; then
            echo "âœ… File exists, checking if it's valid XML..."
            head -n 5 ios/GoogleService-Info.plist
          fi
          
          echo ""
          echo "ğŸ”¥ Checking Firebase pods..."
          ls -la ios/Pods/ | grep -i firebase || echo "No Firebase pods found"
          
          echo ""
          echo "ğŸ” Checking provisioning profiles..."
          ls ~/Library/MobileDevice/Provisioning\ Profiles/ | wc -l
          
          echo ""
          echo "ğŸ”‘ Checking signing identity..."
          security find-identity -v -p codesigning "${{ env.KEYCHAIN_NAME }}" | grep "iPhone Distribution" || echo "âŒ No distribution identity found"
          
          echo ""
          echo "ğŸ“¦ Checking workspace..."
          ls -lh ios/smbmobile.xcworkspace || echo "âŒ Workspace not found"

      - name: Build and Release iOS
        run: |
          set -o pipefail
          fastlane ios qa_release 2>&1 | tee fastlane-output.log || {
            EXIT_CODE=$?
            echo "================================"
            echo "âŒ Build failed with exit code: $EXIT_CODE"
            echo "================================"
            echo ""
            
            # Try to find the build log in multiple locations
            BUILD_LOG=""
            if [ -f fastlane_logs/smbmobile-smbmobile.log ]; then
              BUILD_LOG="fastlane_logs/smbmobile-smbmobile.log"
            elif [ -f ~/Library/Logs/gym/smbmobile-smbmobile.log ]; then
              BUILD_LOG="~/Library/Logs/gym/smbmobile-smbmobile.log"
            fi
            
            if [ -n "$BUILD_LOG" ]; then
              echo "=== XCODEBUILD ERROR DETAILS (from $BUILD_LOG) ==="
              
              # Look for PrecompileModule errors
              if grep -q "PrecompileModule" "$BUILD_LOG"; then
                echo "ğŸ” Found PrecompileModule errors:"
                grep -B 10 -A 30 "PrecompileModule.*failed\|PrecompileModule.*error" "$BUILD_LOG" | head -n 100
                echo ""
              fi
              
              # Look for error: messages
              if grep -q "error:" "$BUILD_LOG"; then
                echo "ğŸ” Found error: messages:"
                grep -A 25 -B 5 "error:" "$BUILD_LOG" | head -n 150
                echo ""
              fi
              
              # Fallback to ARCHIVE FAILED context
              if ! grep -q "error:\|PrecompileModule.*failed" "$BUILD_LOG"; then
                echo "ğŸ” No specific errors found, showing ARCHIVE FAILED context:"
                grep -A 50 "ARCHIVE FAILED\|failed\|FAILED" "$BUILD_LOG" | head -n 150 || {
                  echo "ğŸ” Showing last 250 lines of build log:"
                  tail -n 250 "$BUILD_LOG"
                }
              fi
            else
              echo "âš ï¸ Could not find build log file"
            fi
            
            echo ""
            echo "=== FASTLANE OUTPUT ERRORS ==="
            grep -E "error:|failed:|clang:|PrecompileModule" fastlane-output.log | head -n 50 || echo "No explicit error lines found in fastlane output"
            
            exit $EXIT_CODE
          }
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ env.KEYCHAIN_PASSWORD }}
          KEYCHAIN_NAME: ${{ env.KEYCHAIN_NAME }}
          FASTLANE_XCODEBUILD_SETTINGS_TIMEOUT: 60
          FASTLANE_XCODEBUILD_SETTINGS_RETRIES: 6
      
      - name: Upload Build Logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ios-build-logs
          path: |
            ~/Library/Logs/gym/*.log
            fastlane_logs/*.log
            fastlane-output.log
          retention-days: '7'
          if-no-files-found: ignore

      - name: Cleanup keychain
        if: always()
        run: |
          security delete-keychain "${{ env.KEYCHAIN_NAME }}" 2>/dev/null || true

      - name: Upload iOS Release IPA
        uses: actions/upload-artifact@v4
        with:
          name: ios-release-ipa
          path: ios/build/smbmobile.ipa
          retention-days: '30'
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          body: |
            ## QA Release v${{ github.run_number }}
            ### ğŸ“± Build Artifacts
            - **ğŸ¤– Android AAB**: Download from Actions tab
            - **ğŸ iOS IPA**: Download from Actions tab
            ### ğŸ“‹ Build Details
            - **Commit**: ${{ github.sha }}
            - **Branch**: ${{ github.ref_name }}
            - **Build Number**: ${{ github.run_number }}
            - **Xcode**: 15.4 on macOS 14
            ### ğŸš€ Deployment
            - Android: Internal track on Google Play
            - iOS: TestFlight
          draft: false
          tag_name: qa-v${{ github.run_number }}
          prerelease: true
          name: QA Release v${{ github.run_number }}
          token: ${{ secrets.GITHUB_TOKEN }}