name: QA Release Build

on:
  workflow_dispatch:

jobs:
  qa-build:
    runs-on: macos-15
    name: Build QA Release
    permissions: write-all

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Ruby and Fastlane
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: Install Fastlane
        run: |
          gem install fastlane
          bundle install

      - name: Setup environment variables
        run: |
          echo "KINDE_DOMAIN=${{ vars.KINDE_DOMAIN }}" >> .env
          echo "KINDE_CLIENT_ID=${{ vars.KINDE_CLIENT_ID }}" >> .env
          echo "KINDE_SCOPES=${{ vars.KINDE_SCOPES }}" >> .env
          echo "PUBLIC_API_URL=${{ vars.PUBLIC_API_URL }}" >> .env
          echo "KINDE_AUDIENCE=${{ vars.KINDE_AUDIENCE }}" >> .env

      - name: Create credentials directories
        run: |
          mkdir -p credentials/android
          mkdir -p credentials/ios

      # - name: Setup Android Keystore
      #   run: >
      #     echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode >
      #     credentials/android/release.keystore

      # - name: Setup Google Play Service Key
      #   run: |
      #     echo "${{ secrets.GOOGLE_PLAY_SERVICE_KEY }}" | base64 --decode > credentials/android/google-play-service-key.json

      # - name: Setup Google Services JSON for Android
      #   run: >
      #     echo "${{ secrets.ANDROID_GOOGLE_SERVICES_JSON }}" | base64 --decode >
      #     google-services.json

      # - name: Expo Prebuild for Android
      #   run: npm run prebuild -- --platform android --clean

      # - name: Build and Release Android
      #   run: fastlane android qa_release
      #   env:
      #     ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
      #     ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
      #     ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}

      # - name: Upload Android Release AAB
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: android-release-aab
      #     path: android/app/build/outputs/bundle/release/app-release.aab
      #     retention-days: 30

      - name: Setup Apple API Key
        run: |
          echo "üîê Setting up Apple API Key..."
          base64_content=$(echo "$APP_STORE_CONNECT_API_KEY_BASE64" | \
            sed 's/-----BEGIN PRIVATE KEY-----//g' | \
            sed 's/-----END PRIVATE KEY-----//g' | \
            tr -d ' \n\r\t')

          echo "-----BEGIN PRIVATE KEY-----" > credentials/ios/AuthKey.p8
          echo "$base64_content" | fold -w 64 >> credentials/ios/AuthKey.p8
          echo "-----END PRIVATE KEY-----" >> credentials/ios/AuthKey.p8
          
          echo "‚úÖ Apple API Key created successfully"
          ls -lh credentials/ios/AuthKey.p8
        env:
          APP_STORE_CONNECT_API_KEY_BASE64: ${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}

      - name: Setup Google Service Info Plist for iOS
        run: |
          echo "üì± Setting up Google Service Info Plist..."
          echo "${{ secrets.IOS_GOOGLE_SERVICE_INFO_PLIST }}" | base64 --decode > GoogleService-Info.plist
          echo "‚úÖ GoogleService-Info.plist created"
          ls -lh GoogleService-Info.plist

      - name: Expo Prebuild for iOS
        run: |
          echo "üî® Starting Expo prebuild for iOS..."
          echo "Node version: $(node --version)"
          echo "NPM version: $(npm --version)"
          echo ""
          npm run prebuild -- --platform ios --clean
          echo ""
          echo "‚úÖ Prebuild completed"
          echo "Checking generated iOS directory..."
          ls -la ios/

      - name: Install CocoaPods dependencies
        run: |
          echo "üì¶ Installing CocoaPods dependencies..."
          echo "CocoaPods version: $(pod --version)"
          echo "Ruby version: $(ruby --version)"
          echo ""
          cd ios
          echo "üìù Checking Podfile..."
          cat Podfile
          echo ""
          echo "üîÑ Running pod install..."
          pod install --verbose
          echo ""
          echo "‚úÖ Pod install completed"
          echo "Pods installed:"
          ls -la Pods/ | head -n 20
          cd ..

      - name: Setup SSH for Fastlane Match
        run: |
          mkdir -p ~/.ssh

          if echo "$FASTLANE_MATCH_DEPLOY_KEY" | head -c 5 | grep -q "^-----"; then
            echo "$FASTLANE_MATCH_DEPLOY_KEY" > ~/.ssh/id_rsa
          else
            echo "$FASTLANE_MATCH_DEPLOY_KEY" | base64 --decode > ~/.ssh/id_rsa
          fi

          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan github.com >> ~/.ssh/known_hosts
        env:
          FASTLANE_MATCH_DEPLOY_KEY: ${{ secrets.FASTLANE_MATCH_DEPLOY_KEY }}

      - name: Setup Xcode 16.1
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.1'

      - name: Setup Xcode First Launch and Install iOS 18.1 Runtime
        run: |
          echo "=== Starting Xcode first launch and iOS 18.1 platform download ==="
          sudo xcodebuild -runFirstLaunch
          sudo xcodebuild -license accept || echo "License already accepted"
          
          echo ""
          echo "=== Current iOS runtimes BEFORE download ==="
          xcrun simctl list runtimes | grep iOS || echo "No iOS runtimes found"
          
          echo ""
          echo "=== Initiating iOS platform download ==="
          sudo xcodebuild -downloadPlatform iOS &
          DOWNLOAD_PID=$!
          echo "Download started with PID: $DOWNLOAD_PID"
          
          # Wait for download process to complete
          wait $DOWNLOAD_PID || echo "Download process finished"
          
          # Give additional time for installation to settle
          echo "Waiting 30 seconds for installation to complete..."
          sleep 30
          
          echo ""
          echo "=== iOS runtimes AFTER download ==="
          xcrun simctl list runtimes | grep iOS || echo "No iOS runtimes found"
          
          echo ""
          echo "=== Available SDKs ==="
          xcodebuild -showsdks
          
          echo ""
          echo "=== Final verification ==="
          if xcodebuild -showsdks | grep -q "iphoneos18"; then
            echo "‚úÖ iOS 18.x SDK is installed and ready!"
          elif xcodebuild -showsdks | grep -q "iphoneos"; then
            echo "‚ö†Ô∏è  iOS SDK found, but may not be 18.1. Continuing anyway..."
          else
            echo "‚ùå ERROR: No iOS SDK found!"
            exit 1
          fi
          
      - name: Verify iOS SDK Installation
        run: |
          xcodebuild -version
          echo ""
          echo "=== iOS SDK Path ==="
          xcrun --sdk iphoneos --show-sdk-path
          echo ""
          echo "=== iOS SDK Version ==="
          xcrun --sdk iphoneos --show-sdk-version
          echo ""
          echo "Build destination verification:"
          xcodebuild -workspace ios/smbmobile.xcworkspace -scheme smbmobile -showdestinations || echo "Warning: Could not list destinations"

      - name: Create temporary keychain
        run: |
          echo "üîë Creating temporary keychain..."
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)
          KEYCHAIN_NAME="build.keychain"
          echo "KEYCHAIN_PASSWORD=$KEYCHAIN_PASSWORD" >> $GITHUB_ENV
          echo "KEYCHAIN_NAME=$KEYCHAIN_NAME" >> $GITHUB_ENV
          
          echo "Deleting old keychain if exists..."
          security delete-keychain "$KEYCHAIN_NAME" 2>/dev/null || true
          
          echo "Creating new keychain: $KEYCHAIN_NAME"
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"
          
          echo "Adding to keychain list..."
          EXISTING_KEYCHAINS=$(security list-keychains -d user | tr -d '"' | tr '\n' ' ')
          security list-keychains -d user -s "$KEYCHAIN_NAME" $EXISTING_KEYCHAINS
          
          echo "Setting as default keychain..."
          security default-keychain -s "$KEYCHAIN_NAME"
          
          echo "Unlocking keychain..."
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"
          
          echo "Configuring keychain settings..."
          security set-keychain-settings -t 3600 -u "$KEYCHAIN_NAME"
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME" 2>/dev/null || true
          
          echo "‚úÖ Keychain created and configured"
          echo "Current keychains:"
          security list-keychains

      - name: Unlock keychain
        run: |
          echo "üîì Unlocking keychain..."
          security unlock-keychain -p "${{ env.KEYCHAIN_PASSWORD }}" "${{ env.KEYCHAIN_NAME }}"
          echo "‚úÖ Keychain unlocked"
          security show-keychain-info "${{ env.KEYCHAIN_NAME }}" || echo "Could not show keychain info"

      - name: Verify Xcode Workspace
        run: |
          echo "üîç Verifying Xcode workspace and project..."
          cd ios
          echo ""
          echo "=== iOS directory contents ==="
          ls -la
          echo ""
          echo "=== Checking workspace ==="
          if [ -d "smbmobile.xcworkspace" ]; then
            echo "‚úÖ Workspace exists"
            ls -la smbmobile.xcworkspace/
          else
            echo "‚ùå Workspace not found!"
            exit 1
          fi
          
          echo ""
          echo "=== Checking project ==="
          if [ -d "smbmobile.xcodeproj" ]; then
            echo "‚úÖ Project exists"
            ls -la smbmobile.xcodeproj/
          else
            echo "‚ùå Project not found!"
          fi
          
          echo ""
          echo "=== Available schemes ==="
          xcodebuild -workspace smbmobile.xcworkspace -list
          
          echo ""
          echo "=== Checking build settings ==="
          xcodebuild -workspace smbmobile.xcworkspace -scheme smbmobile -showBuildSettings | grep -E "(PRODUCT_BUNDLE_IDENTIFIER|CODE_SIGN|DEVELOPMENT_TEAM|PROVISIONING_PROFILE)" || echo "Could not retrieve build settings"
          cd ..

      - name: Clean Xcode build cache
        run: |
          echo "üßπ Cleaning Xcode build cache..."
          echo "Removing DerivedData..."
          rm -rf ~/Library/Developer/Xcode/DerivedData/*
          echo "‚úÖ DerivedData cleaned"
          
          echo ""
          echo "Cleaning Xcode workspace..."
          cd ios
          xcodebuild clean -workspace smbmobile.xcworkspace -scheme smbmobile || echo "‚ö†Ô∏è  Clean failed, continuing anyway"
          echo "‚úÖ Xcode clean completed"
          cd ..

      - name: Build and Release iOS
        run: |
          set -o pipefail
          echo "üöÄ ============================================="
          echo "üöÄ Starting iOS build and release process"
          echo "üöÄ ============================================="
          echo ""
          echo "üìã Build Environment Information:"
          echo "  - Xcode version: $(xcodebuild -version | head -n 1)"
          echo "  - Xcode path: $(xcode-select -p)"
          echo "  - iOS SDK: $(xcrun --sdk iphoneos --show-sdk-version)"
          echo "  - iOS SDK path: $(xcrun --sdk iphoneos --show-sdk-path)"
          echo "  - macOS version: $(sw_vers -productVersion)"
          echo "  - Ruby version: $(ruby --version)"
          echo "  - Fastlane version: $(fastlane --version | head -n 1)"
          echo ""
          echo "üîê Code Signing Information:"
          echo "  - Default keychain: $(security default-keychain)"
          echo "  - Keychains: $(security list-keychains)"
          echo ""
          echo "üìù Environment Variables:"
          echo "  - KEYCHAIN_NAME: $KEYCHAIN_NAME"
          echo "  - APP_STORE_CONNECT_API_KEY_ID: ${APP_STORE_CONNECT_API_KEY_ID:0:10}..."
          echo "  - APP_STORE_CONNECT_ISSUER_ID: ${APP_STORE_CONNECT_ISSUER_ID:0:10}..."
          echo ""
          echo "üèóÔ∏è  Starting Fastlane build..."
          echo "============================================="
          echo ""
          
          fastlane ios qa_release 2>&1 | tee build_output.log
          
          BUILD_EXIT_CODE=${PIPESTATUS[0]}
          echo ""
          echo "============================================="
          echo "üèÅ Fastlane process completed with exit code: $BUILD_EXIT_CODE"
          echo "============================================="
          
          exit $BUILD_EXIT_CODE
        continue-on-error: true
        id: ios_build
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ env.KEYCHAIN_PASSWORD }}
          KEYCHAIN_NAME: ${{ env.KEYCHAIN_NAME }}
          FASTLANE_XCODEBUILD_SETTINGS_TIMEOUT: 60
          FASTLANE_XCODEBUILD_SETTINGS_RETRIES: 6
          FASTLANE_HIDE_GITHUB_ISSUES: 1
          FASTLANE_SKIP_UPDATE_CHECK: 1
          FASTLANE_XCODE_LIST_TIMEOUT: 60
          DEBUG: 1

      - name: Extract and Display Build Errors
        if: steps.ios_build.outcome == 'failure'
        run: |
          echo "‚ùå ============================================="
          echo "‚ùå BUILD FAILED - Extracting Error Information"
          echo "‚ùå ============================================="
          echo ""
          
          echo "üìä Build output file size: $(wc -l < build_output.log) lines"
          echo ""
          
          # Extract various error patterns
          echo "üîç === COMPILATION ERRORS ==="
          if grep -E "error:" build_output.log > /tmp/compilation_errors.txt 2>/dev/null; then
            echo "Found $(wc -l < /tmp/compilation_errors.txt) error lines:"
            head -n 50 /tmp/compilation_errors.txt
          else
            echo "‚ùå No compilation errors with 'error:' pattern found"
          fi
          
          echo ""
          echo "üîó === LINKER ERRORS ==="
          if grep -E "(ld: |Undefined symbol|duplicate symbol|symbol not found)" build_output.log > /tmp/linker_errors.txt 2>/dev/null; then
            echo "Found $(wc -l < /tmp/linker_errors.txt) linker error lines:"
            head -n 50 /tmp/linker_errors.txt
          else
            echo "No linker errors found"
          fi
          
          echo ""
          echo "üì¶ === MODULE/FRAMEWORK ERRORS ==="
          if grep -iE "(No such module|framework not found|could not build module|module.*not found)" build_output.log > /tmp/module_errors.txt 2>/dev/null; then
            echo "Found $(wc -l < /tmp/module_errors.txt) module error lines:"
            head -n 50 /tmp/module_errors.txt
          else
            echo "No module/framework errors found"
          fi
          
          echo ""
          echo "‚ö†Ô∏è  === WARNINGS ==="
          grep -iE "warning:" build_output.log | head -n 20 || echo "No warnings found"
          
          echo ""
          echo "üí• === FAILED COMMANDS ==="
          if grep -B 5 -E "(\*\* BUILD FAILED \*\*|Command.*failed|The following build commands failed)" build_output.log > /tmp/failed_commands.txt 2>/dev/null; then
            echo "Found failed commands:"
            head -n 100 /tmp/failed_commands.txt
          else
            echo "No failed command patterns found"
          fi
          
          echo ""
          echo "üìù === ERROR CONTEXT (10 lines before and after each error) ==="
          grep -B 10 -A 10 "error:" build_output.log | head -n 300 || echo "No detailed error context found"
          
          echo ""
          echo "üîé === SEARCHING FOR SPECIFIC ERROR PATTERNS ==="
          echo "Checking for common issues..."
          grep -iE "(PrecompileModule|clang.*failed|swift.*failed|exit code 1)" build_output.log | head -n 30 || echo "No common error patterns found"
          
          echo ""
          echo "üìÑ === LAST 200 LINES OF BUILD OUTPUT ==="
          tail -n 200 build_output.log
          
          echo ""
          echo "üìÇ === CHECKING FOR FASTLANE LOGS ==="
          if [ -d "fastlane/logs" ]; then
            echo "Fastlane logs directory exists:"
            ls -lh fastlane/logs/
            echo ""
            
            # Find the most recent log file
            LATEST_LOG=$(find fastlane/logs -type f -name "*.log" -print0 | xargs -0 ls -t | head -n 1)
            if [ -n "$LATEST_LOG" ]; then
              echo "=== Latest Fastlane log: $LATEST_LOG ==="
              echo "File size: $(wc -l < "$LATEST_LOG") lines"
              echo ""
              echo "Errors from Fastlane log:"
              grep -B 10 -A 10 "error:" "$LATEST_LOG" | head -n 300 || echo "No errors in fastlane log"
              echo ""
              echo "Last 100 lines of Fastlane log:"
              tail -n 100 "$LATEST_LOG"
            fi
          else
            echo "‚ùå Fastlane logs directory not found"
          fi
          
          echo ""
          echo "üîç === CHECKING XCODE BUILD LOGS ==="
          if [ -d "$HOME/Library/Logs/gym" ]; then
            echo "Gym logs found:"
            ls -lht "$HOME/Library/Logs/gym" | head -n 10
            LATEST_GYM_LOG=$(find "$HOME/Library/Logs/gym" -type f -name "*.log" -print0 | xargs -0 ls -t | head -n 1)
            if [ -n "$LATEST_GYM_LOG" ]; then
              echo ""
              echo "Latest gym log: $LATEST_GYM_LOG"
              echo "Last 100 lines:"
              tail -n 100 "$LATEST_GYM_LOG"
            fi
          fi
          
          echo ""
          echo "üìä === BUILD FAILURE SUMMARY ==="
          echo "Total 'error:' occurrences: $(grep -c "error:" build_output.log || echo 0)"
          echo "Total 'warning:' occurrences: $(grep -c "warning:" build_output.log || echo 0)"
          echo "Total 'failed' occurrences: $(grep -ic "failed" build_output.log || echo 0)"
          echo ""
          echo "============================================="
          echo "Full build logs saved to artifacts for download"
          echo "Download 'ios-full-build-output' and 'ios-build-logs' artifacts"
          echo "============================================="
          
          exit 1

      - name: Upload Full Build Output
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-full-build-output
          path: build_output.log
          retention-days: 7

      - name: Cleanup keychain
        if: always()
        run: |
          security delete-keychain "${{ env.KEYCHAIN_NAME }}" 2>/dev/null || true

      - name: Upload Build Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-build-logs
          path: |
            build_output.log
            fastlane/logs/**/*.log
            ~/Library/Logs/gym/**/*.log
          retention-days: 7
          if-no-files-found: ignore

      - name: Upload iOS Release IPA
        uses: actions/upload-artifact@v4
        with:
          name: ios-release-ipa
          path: ios/build/smbmobile.ipa
          retention-days: 30

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          body: |
            ## QA Release v${{ github.run_number }}
            ### üì± Build Artifacts
            - **ü§ñ Android AAB**: Download from Actions tab
            - **üçé iOS IPA**: Download from Actions tab
            ### üìã Build Details
            - **Commit**: ${{ github.sha }}
            - **Branch**: ${{ github.ref_name }}
            - **Build Number**: ${{ github.run_number }}
            - **Xcode**: 16.1 with iOS 18.1 runtime
            ### üöÄ Deployment
            - Android: Internal track on Google Play
            - iOS: TestFlight
          draft: false
          tag_name: qa-v${{ github.run_number }}
          prerelease: true
          name: QA Release v${{ github.run_number }}
          token: ${{ secrets.GITHUB_TOKEN }}
